---
title: c++函数返回值
date: 2021-01-16 11:04:28
tags: c++
categories: c++
---
在c++函数中可以返回value、指针、引用等类型的值，本问介绍下返回三种类型的值的区别。
#### 返回值(value)
函数返回值(value)是最简单，并且是最安全的。当函数返回一个value的时候，会拷贝这个value的内容给调用方，所以它是安全的。  
另一个使用value作为返回类型的好处是，如果返回的是在函数内部定义的局部变量，也不会有作用域的问题，因为是返回的值的拷贝。
<!-- more -->
```c++
int doubleValue(int x) {
    int value{x*2};
    return value;
}
```
当返回值是在函数内部定义，或者返回通过值传递的函数参数时，按值返回最合适。 但是，就像函数参数按值传递，对于结构和大型类，按值返回很慢，影响程序性能。  
应该按值返回的情况:
- 返回函数内部定义的局部变量时
- 返回按值传递的函数参数时
不应该按值返回的情况:
- 返回内置数组或指针时（应该使用按地址返回）
- 返回大型结构或类时（应该使用按引用返回）

### 返回地址(指针)
按地址返回意味着将变量的地址返回给调用方。 与按地址传递类似，按地址返回只能返回变量的地址，而不能返回数字或表达式（没有地址）。 由于按地址返回只是将地址从函数复制到调用方，因此按地址返回速度很快。  
但是，按地址返回有一个按值返回没有的缺点:如果尝试返回函数本地变量的地址，则程序将表现出未定义的行为。 考虑以下示例：
```c++
int *doubleValue(int x) {
    int value{2*x};
    return &value;
}// value在函数结束的时候被销毁，&value的值就是一个无效值了
```
在上面的例子可以看到，值在返回给调用方之后就被销毁。 最终结果是，调用者最终以未分配的内存（野指针）的地址作为结果，如果使用该地址将引起问题。 这是新程序员经常犯的错误。 如果程序员尝试按地址返回局部变量，许多较新的编译器都会发出警告（不是错误）。但是，有很多方法可以屏蔽编译器的该特性，使得在不生成警告的情况下进行非法操作，因此 确保程序返回的指针将在函数返回后指向有效变量成了程序员的负担。  
但是，按地址返回通常用于将动态分配的内存返回给调用者：
```c++
int allocateArray(int size) {
    return new int[size];
}

int main() {
    int *array{allocateArray(10)};

    delete[] array;
    return 0;
}
```
上面的代码是可以正常运行的，因为动态分配的内存在声明它的程序块的末尾不会超出其作用域，因此当地址返回给调用者时，内存仍将存在。 跟踪手动分配的内存可能很困难。 将分配和释放内存分成不同的功能，这使得了解谁负责释放资源或根本是否需要释放资源变得更加困难。 应该使用智能指针和能够自动释放资源的类型，而不是手动分配内存。  
应该按地址返回的情况:
- 返回动态分配的内存时
- 返回通过地址传递的函数参数时  

不应该按地址返回的情况:
- 返回在函数内部声明的变量或按值传递的参数时（使用按值返回）
- 返回通过引用传递的大型结构或类时（使用按引用返回）
注意： 上面提到关于`传递`,是指形参的传递方式。

#### 返回引用
类似于按地址返回，按引用返回的值必须是变量（不应返回对字面值或解析为临时值的表达式的引用，因为它们将超出函数作用域，从而最终返回一个空的引用）。 通过引用返回变量时，对该变量的引用将传递回调用方。 然后，调用者可以使用该引用来继续修改变量，这有时会很有用。 按引用返回在运行上也很快，这在返回结构和类时很有用。  
但是，就像按地址返回一样，不应通过引用返回局部变量。 考虑下面的例子：
```c++
int& doubleValue(int x) {
    int value{x*2};
    return value;
}
```
在上述程序中，程序将返回对值的引用，该值将在函数返回时销毁。 这将意味着调用方接收到的返回是一个无效的引用。 辛运的是，如果尝试这样做，编译器可能会给警告或错误。  
按引用返回经常用在，使用引用传递参数的函数中，函数返回参数的引用。看下面的例子:
```c++
#include <iostream>
#include <array>

int& getElement(std::array<int, 15> &array, int index) {
    return array[index];
}

int main() {
    std::array<int, 15> arr;
    getElement(arr, 4) = 99;
    std::cout << arr[4] << '\n';
    return 0;
}
```
应该按引用返回的情况:
- 返回一个引用参数(传入的参数是引用类型的)
- 返回通过引用或地址传递到函数中的对象的成员时
- 当返回一个大型结构或类，该结构或类在函数结束时不会被破坏（例如，通过引用传入的结构或类）  

不应该按引用返回的情况:
- 返回在函数内部声明的变量或按值传递的参数时（应该使用按值返回）
- 返回函数内部定义的数组或指针值时（使用按地址返回）

#### 总结
总之，在确认函数返回值类型时，使用值返回是最方便也是最安全的，但是会有性能问题。如果需要使用返回引用或者返回指针，那么需要确认最终返回的对象的作用域不会被超出。
